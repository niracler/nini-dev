# Design: Bokushi 博客功能增强

## 设计方法论

本次前端实现遵循 **Vercel Design Guidelines** 和 **Rams 无障碍审查** 的原则，确保组件既美观又可访问。

### 交互设计原则 (Vercel)

| 原则 | 要求 |
|------|------|
| 键盘可操作 | 所有流程支持键盘操作，遵循 WAI-ARIA 模式 |
| 焦点可见 | 使用 `:focus-visible` 提供清晰的焦点指示器 |
| 触控区域 | 最小 24px，移动端最小 44px |
| 深度链接 | 可分享、可收藏的状态 URL |
| 语义化 HTML | 优先使用原生语义元素，ARIA 作为补充 |

### 视觉设计原则 (Vercel)

| 原则 | 要求 |
|------|------|
| 层次阴影 | 模拟环境光和直射光的双层阴影 |
| 同心圆角 | 子元素圆角 ≤ 父元素圆角，曲线对齐 |
| 色彩一致 | 非中性背景上保持色相一致性 |
| 色盲友好 | 图表使用色盲友好调色板 |
| 国际化 | 日期、时间、数字按用户 locale 格式化 |

### 无障碍检查清单 (Rams / WCAG 2.1)

**Critical (必须修复)**

| 检查项 | WCAG | 说明 |
|--------|------|------|
| 图片 alt 属性 | 1.1.1 | `<img>` 必须有 `alt` |
| 图标按钮标签 | 4.1.2 | 纯图标 `<button>` 需要 `aria-label` |
| 表单标签 | 1.3.1 | `<input>` 需关联 `<label>` 或 `aria-label` |
| 语义化交互 | 2.1.1 | 避免 `<div onClick>`，使用 `<button>` |

**Serious (应该修复)**

| 检查项 | WCAG | 说明 |
|--------|------|------|
| 焦点轮廓 | 2.4.7 | 移除 `outline` 时必须提供替代焦点样式 |
| 键盘处理 | 2.1.1 | `onClick` 需配合 `onKeyDown` |
| 非色彩信息 | 1.4.1 | 状态不仅靠颜色区分，需有图标/文字 |
| 触控目标 | 2.5.5 | 可点击元素不小于 44x44px |

## Context

Bokushi 是基于 Astro 构建的个人博客，部署在 Cloudflare Pages。当前技术栈：

- **框架**: Astro + TypeScript
- **样式**: Tailwind CSS
- **部署**: Cloudflare Pages (静态站点 + 部分 SSR)
- **评论**: Remark42 (自托管)
- **动态页**: Telegram Channel 集成 (SSR)

**目标读者**: 技术博客读者，关注 ACG、编程、生活

## Goals / Non-Goals

**Goals:**

- 提升内容发现效率（搜索、推荐）
- 增强传播能力（分享按钮）
- 融入独立博客生态（IndieWeb）
- 保持静态站点的简洁性

**Non-Goals:**

- 不引入复杂后端服务（优先 build-time 方案）
- 不改变现有页面结构
- 不增加运行时依赖（除非必要）

## Phase 1: 全文搜索 (Pagefind)

### 技术选型

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| **Pagefind** | 零服务端、自动索引、轻量 | UI 需自定义 | ✅ 选择 |
| Algolia | 功能强大 | 需要外部服务、有免费额度限制 | ❌ |
| Fuse.js | 纯前端 | 需要加载全部内容到客户端 | ❌ |

### 架构

```
Build Time:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Astro Build │ ──▶ │  Pagefind   │ ──▶ │ Search Index│
│             │     │  Indexing   │     │ (_pagefind/)│
└─────────────┘     └─────────────┘     └─────────────┘

Runtime:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   User      │ ──▶ │  Search UI  │ ──▶ │ Pagefind   │
│   Input     │     │ (Component) │     │   WASM     │
└─────────────┘     └─────────────┘     └─────────────┘
```

### UI 方案

- **触发方式**: 导航栏搜索图标 + 快捷键 `Cmd/Ctrl + K`
- **展示方式**: 模态框 (Modal) 覆盖
- **搜索结果**: 标题 + 摘要高亮 + 分类标签

## Phase 2: 文章分享按钮

### 位置设计

```
┌────────────────────────────────────────────────┐
│ Header                                         │
├────────┬───────────────────────────────────────┤
│        │                                       │
│ Share  │         Article Content               │
│ Button │                                       │
│ (固定) │                                       │
│        │                                       │
│  🐦    │                                       │
│  ✈️    │                                       │
│  🔗    │                                       │
│        │                                       │
├────────┴───────────────────────────────────────┤
│ Footer                                         │
└────────────────────────────────────────────────┘
```

### 分享渠道

| 渠道 | 实现方式 | 优先级 |
|------|----------|--------|
| Twitter/X | `https://twitter.com/intent/tweet?url=...` | P0 |
| Telegram | `https://t.me/share/url?url=...` | P0 |
| 复制链接 | `navigator.clipboard.writeText()` | P0 |
| 微信 | QR Code 生成 | P1 (可选) |

### 交互细节

- 固定在视口左侧，滚动时保持可见
- 移动端：收起为悬浮按钮或底部工具栏
- 复制成功后显示 Toast 提示

## Phase 3: IndieWeb / Webmentions

### 技术选型

| 方案 | 说明 | 决策 |
|------|------|------|
| **webmention.io** | 托管服务，免费 | ✅ 接收 |
| **Bridgy** | 从 Twitter/Mastodon 拉取 | ✅ 可选 |
| 自建 | 需要服务器 | ❌ |

### 架构

```
发送 Webmention:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  发布文章   │ ──▶ │ Build Hook  │ ──▶ │  发现链接   │
│             │     │ (可选)      │     │  发送通知   │
└─────────────┘     └─────────────┘     └─────────────┘

接收 Webmention:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 其他网站    │ ──▶ │webmention.io│ ──▶ │  API 获取   │
│ 提及本站    │     │  (托管)     │     │  展示互动   │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 展示设计

在文章末尾评论区上方展示：

- **Likes**: 头像列表
- **Reposts**: 头像 + 来源链接
- **Mentions**: 类似评论展示

## Phase 4: AI 相关文章推荐

### 技术选型

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| **Build-time 预计算** | 无运行时依赖 | 文章更新需重新 build | ✅ 优先 |
| Cloudflare Vectorize | 边缘运行 | 需要 Workers 配合 | 🤔 备选 |
| 外部 API (Pinecone等) | 功能强大 | 需要付费、增加延迟 | ❌ |

### Build-time 方案架构

```
Build Time:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   文章内容   │ ──▶ │  Embedding  │ ──▶ │   相似度    │
│   (MDX)     │     │  生成脚本   │     │   计算      │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  向量存储   │     │ 推荐 JSON   │
                    │  (可选)     │     │ (per post)  │
                    └─────────────┘     └─────────────┘

Runtime:
┌─────────────┐     ┌─────────────┐
│  文章页面   │ ──▶ │ 读取预计算  │
│             │     │ 推荐数据    │
└─────────────┘     └─────────────┘
```

### Embedding 选型

| 模型 | 维度 | 特点 | 决策 |
|------|------|------|------|
| OpenAI text-embedding-3-small | 1536 | 高质量、需 API | ✅ 优先 |
| Ollama local embedding | 可选 | 免费、本地运行 | 🤔 备选 |
| Sentence Transformers | 384-768 | 开源、本地运行 | 🤔 备选 |

### 推荐算法

1. 文章发布时生成 embedding
2. 计算所有文章两两之间的余弦相似度
3. 为每篇文章保存 Top 3-5 相关文章
4. Build 时生成静态 JSON 文件

### 展示设计

文章末尾、评论区之前：

```
┌─────────────────────────────────────────────────┐
│  相关文章                                        │
├─────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐         │
│  │ 文章 1  │  │ 文章 2  │  │ 文章 3  │         │
│  │ 相似 92%│  │ 相似 87%│  │ 相似 81%│         │
│  └─────────┘  └─────────┘  └─────────┘         │
└─────────────────────────────────────────────────┘
```

## Risks / Trade-offs

| Risk | Mitigation |
|------|------------|
| Phase 4 Embedding 成本 | 使用 build-time 缓存，增量更新 |
| IndieWeb 互动稀少 | 接入 Bridgy 拉取社交媒体互动 |
| 搜索索引体积过大 | Pagefind 默认压缩，可配置排除 |

## Open Questions

- [ ] Phase 4 是否需要实时推荐（基于阅读历史）？暂定仅静态推荐
- [ ] IndieWeb 是否需要发送 Webmention？还是仅接收？
- [ ] 分享按钮是否需要统计点击次数？
